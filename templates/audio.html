<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Live Audio Scam Detection</title>

<style>
body {
    margin: 0;
    height: 150vh;
    font-family: "Segoe UI", Tahoma, sans-serif;
    background: linear-gradient(135deg, #1d2671, #c33764);
    display: flex;
    justify-content: center;
    align-items: center;
}

.card {
    background: rgb(241, 245, 245);
    width: 760px;
    padding: 40px;
    border-radius: 16px;
    box-shadow: 0 15px 40px rgba(0,0,0,0.25);
}

h2 { text-align:center; margin-bottom:5px; }
p.subtitle { text-align:center; color:#666; margin-bottom:15px; }

.controls {
    display:flex;
    justify-content:center;
    gap:15px;
    margin:20px 0;
}

.btn {
    padding:4px 20px;
    font-size:30px;
    border:none;
    border-radius:30px;
    cursor:pointer;
    color:white;
}

.start { background:linear-gradient(135deg,#00c6ff,#0072ff); }
.stop  { background:linear-gradient(135deg,#ff416c,#ff4b2b); }
.clear { background:linear-gradient(135deg,#7f8c8d,#2c3e50); }

.status {
    text-align:center;
    font-weight:600;
    margin-bottom:10px;
}

/* Waveform */
.wave-container {
    background:#111;
    border-radius:10px;
    padding:10px;
    margin-bottom:15px;
}
canvas { width:100%; height:80px; }

/* Notepad */
.notepad {
    background:#9dc1e4;
    padding:15px;
    border-radius:8px;
    min-height:120px;
    max-height:200px;
    overflow-y:auto;
    font-family:Consolas, monospace;
    white-space:pre-wrap;
    line-height:1.6;
    border:1px solid #0c0101;
}

/* Keyword highlight */
.highlight {
    color:#d60000;
    font-weight:bold;
}

/* Confidence bar */
.progress {
    background:#e0e0e0;
    border-radius:10px;
    overflow:hidden;
    height:18px;
}
.progress-bar {
    height:100%;
    width:0%;
    transition:width 0.4s ease;
}

/* Save badge */
.saved {
    text-align:center;
    color:#c0392b;
    font-weight:600;
    margin-top:8px;
    display:none;
}

.section { margin-top:15px; }
.label { font-weight:600; margin-bottom:5px; }
.box {
    background:#f4f6f8;
    padding:12px;
    border-radius:8px;
}

.back {
    text-align:center;
    margin-top:20px;
    color:#0e0101;
}
.back a {
    text-decoration:none;
    color:#cebcbc;
}
</style>
</head>

<body>

<div class="card">
    
    <p class="subtitle">Real-time detection</p>

    <div class="controls">
        <button class="btn start" onclick="startListening()">‚ñ∂ Start</button>
        <button class="btn stop" onclick="stopListening()">‚èπ Stop</button>
        <button class="btn clear" onclick="clearText()">Clear</button>
    </div>

    <div class="status" id="status">Idle</div>

    <div class="wave-container">
        <canvas id="wave"></canvas>
    </div>

    <div class="section">
        <div class="label">Live Transcription</div>
        <div class="notepad" id="text"></div>
    </div>

    <div class="section">
        <div class="label">Result</div>
        <div class="box" id="result">‚Äî</div>
    </div>

    <div class="section">
        <div class="label">Confidence</div>
        <div class="progress">
            <div class="progress-bar" id="confBar"></div>
        </div>
        <div class="box" id="confidence">‚Äî</div>
    </div>

    <div class="saved" id="saved">üíæ Transcript saved to file</div>

    <div class="section">
        <div class="label">Detected Keywords</div>
        <div class="box" id="keywords">None</div>
    </div>

    <div class="back">
        <button class="back" onclick="location.href='/'">
         back
    </div>
</div>

<script>
let listening=false, interval;

/* Wave vars */
let audioCtx, analyser, dataArray, source, stream;
const canvas=document.getElementById("wave");
const ctx=canvas.getContext("2d");
canvas.width=canvas.offsetWidth;
canvas.height=canvas.offsetHeight;

/* Highlight keywords */
function highlightKeywords(text, keywords){
    let out=text;
    keywords.forEach(kw=>{
        out=out.replace(new RegExp(`(${kw})`,"gi"),
            `<span class="highlight">$1</span>`);
    });
    return out;
}

/* Start */
async function startListening(){
    if(listening) return;
    listening=true;
    document.getElementById("status").innerText="Listening‚Ä¶";
    interval=setInterval(poll,400);

    audioCtx=new (window.AudioContext||window.webkitAudioContext)();
    stream=await navigator.mediaDevices.getUserMedia({audio:true});
    source=audioCtx.createMediaStreamSource(stream);
    analyser=audioCtx.createAnalyser();
    analyser.fftSize=2048;
    dataArray=new Uint8Array(analyser.fftSize);
    source.connect(analyser);
    drawWave();
}

/* Stop */
function stopListening(){
    listening=false;
    clearInterval(interval);
    document.getElementById("status").innerText="Stopped";
    if(stream) stream.getTracks().forEach(t=>t.stop());
    if(audioCtx) audioCtx.close();
    fetch("/reset");
}

/* Clear */
function clearText(){
    fetch("/reset");
    document.getElementById("text").innerHTML="";
    document.getElementById("result").innerText="‚Äî";
    document.getElementById("confidence").innerText="‚Äî";
    document.getElementById("keywords").innerText="None";
    document.getElementById("confBar").style.width="0%";
    document.getElementById("saved").style.display="none";
    document.getElementById("status").innerText="Cleared";
}

/* Wave */
function drawWave(){
    if(!listening) return;
    requestAnimationFrame(drawWave);
    analyser.getByteTimeDomainData(dataArray);
    ctx.fillStyle="#111";
    ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.strokeStyle="#00e5ff";
    ctx.beginPath();
    let x=0;
    const slice=canvas.width/dataArray.length;
    for(let i=0;i<dataArray.length;i++){
        const y=(dataArray[i]/128)*canvas.height/2;
        i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);
        x+=slice;
    }
    ctx.stroke();
}

/* Poll backend */
async function poll(){
    if(!listening) return;
    const r=await fetch("/listen");
    const d=await r.json();

    document.getElementById("text").innerHTML=
        highlightKeywords(d.text||"",d.keywords||[]);
    document.getElementById("result").innerText=d.result||"Listening‚Ä¶";
    document.getElementById("confidence").innerText=d.confidence||"‚Äî";
    document.getElementById("keywords").innerText=
        d.keywords?.length?d.keywords.join(", "):"None";

    const pct=parseFloat(d.confidence)||0;
    const bar=document.getElementById("confBar");
    bar.style.width=pct+"%";
    bar.style.background=pct>=40?"#e74c3c":"#2ecc71";
    document.getElementById("saved").style.display=
        pct>=40?"block":"none";
}
</script>

</body>
</html>
